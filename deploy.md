# Deploy Guide: NextMile Telegram WebApp

Полная инструкция по развертыванию прототипа NextMile: база данных (Supabase), backend-бот (Telegram), frontend (Next.js WebApp), переменные окружения и интеграция.

---

## 1. Клонирование репозитория

```bash
git clone <URL-ВАШЕГО-РЕПОЗИТОРИЯ>
cd NextMileApp
```

---

## 2. Инициализация Supabase (База данных)

1. Зарегистрируйтесь на [supabase.com](https://supabase.com/) и создайте новый проект.
2. Перейдите в **Table Editor** или **SQL Editor**.
3. Выполните SQL-код для создания таблиц:

```sql
-- Goals
create table if not exists public.goals (
  id bigint generated by default as identity primary key,
  title text not null,
  category text not null,
  deadline date not null,
  progress integer default 0
);

-- Tasks
create table if not exists public.tasks (
  id bigint generated by default as identity primary key,
  title text not null,
  goal_id bigint references public.goals(id) on delete cascade,
  complexity text,
  status text default 'todo'
);

-- Plans
create table if not exists public.plans (
  id bigint generated by default as identity primary key,
  goal_id bigint references public.goals(id) on delete cascade,
  sprint integer not null,
  description text not null
);
```

4. (Если включён RLS) Добавьте политики доступа для анонимных пользователей:

```sql
create policy "Allow anon insert/select on goals"
  on public.goals
  for all
  using (true)
  with check (true);

create policy "Allow anon insert/select on tasks"
  on public.tasks
  for all
  using (true)
  with check (true);

create policy "Allow anon insert/select on plans"
  on public.plans
  for all
  using (true)
  with check (true);
```

5. Получите значения:
   - **Project URL** (например, `https://xxxx.supabase.co`)
   - **anon public key** (раздел Project Settings → API)

---

## 3. Настройка переменных окружения

Создайте файл `.env.local` в корне проекта:

```
NEXT_PUBLIC_SUPABASE_URL=ВАШ_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=ВАШ_SUPABASE_ANON_KEY
```

---

## 4. Деплой и настройка Telegram-бота (Backend)

1. Создайте бота через [@BotFather](https://t.me/BotFather) и получите токен.
2. Реализуйте backend-бота (например, на Node.js с telegraf или на Python с aiogram). Пример для Node.js:

```js
const { Telegraf } = require('telegraf');
const bot = new Telegraf(process.env.BOT_TOKEN);

bot.start((ctx) => {
  ctx.reply('Добро пожаловать! Откройте WebApp:', {
    reply_markup: {
      keyboard: [[{ text: 'Открыть NextMile', web_app: { url: 'https://ВАШ_ДОМЕН.vercel.app' } }]],
      resize_keyboard: true,
      one_time_keyboard: true,
    },
  });
});

bot.launch();
```

3. Добавьте переменные окружения для бота (например, `.env`):
```
BOT_TOKEN=ваш_токен_бота
```

4. Задеплойте бота на любой сервер (например, Render, Railway, Heroku, VPS).

---

## Запуск Telegram-бота с помощью PM2

Для надёжной работы Telegram-бота на сервере используйте [PM2](https://pm2.keymetrics.io/):

1. Установите PM2 глобально:
   ```bash
   npm install -g pm2
   ```
2. Запустите бота через PM2 (замените `bot.js` на имя вашего файла):
   ```bash
   pm2 start bot.js --name nextmile-bot
   ```
3. Проверьте статус:
   ```bash
   pm2 status
   ```
4. Перезапустите бота:
   ```bash
   pm2 restart nextmile-bot
   ```
5. Остановите бота:
   ```bash
   pm2 stop nextmile-bot
   ```
6. Для автозапуска после перезагрузки сервера:
   ```bash
   pm2 startup
   pm2 save
   ```

PM2 автоматически перезапустит бота при сбое или после перезагрузки сервера.

---

## 5. Деплой Frontend (Next.js WebApp)

1. Установите зависимости:
```bash
npm install
```
2. Проверьте работу локально:
```bash
npm run dev
```
3. Задеплойте на [Vercel](https://vercel.com/) (или другой хостинг):
   - Подключите репозиторий.
   - В настройках проекта добавьте переменные окружения из `.env.local`.
   - Запустите деплой.

---

## 6. Интеграция WebApp с Telegram-ботом

1. В коде бота укажите актуальный URL вашего WebApp (например, `https://nextmile.vercel.app`).
2. В Telegram нажмите на кнопку "Открыть NextMile" — WebApp откроется внутри Telegram.

---

## 7. Проверка работоспособности

- Создайте цель через WebApp — она должна появиться в Supabase.
- После создания цели автоматически появится план из 3 спринтов.
- Dashboard покажет ваши цели и задачи на день.
- WebApp должен открываться по кнопке в Telegram-боте.

---

## 8. Troubleshooting

- **404 Not Found при работе с Supabase:** Проверьте, что таблицы созданы и названы правильно.
- **Ошибка создания цели:** Проверьте права доступа (RLS) и переменные окружения.
- **WebApp не открывается в Telegram:** Проверьте, что URL указан в web_app кнопке бота.
- **Бот не отвечает:** Проверьте токен и логи сервера, где он запущен.

---

## 9. Дополнительно
- Для production рекомендуется ограничить политики доступа Supabase и реализовать авторизацию пользователей.
- Для AI-плана можно интегрировать реальный AI-сервис (OpenAI API и др.).

---

**Если что-то не работает — проверьте логи, консоль браузера и логи Supabase.**

---